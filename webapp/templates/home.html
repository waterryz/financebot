{% extends "layout.html" %}
{% block content %}

<div class="mt-6 space-y-8">

    <!-- =======================
    –ü–†–ò–í–ï–¢–°–¢–í–ò–ï
    ======================= -->
    <section class="bg-slate-900/80 rounded-3xl border border-white/10 p-6">
        <p class="text-xs uppercase tracking-[0.18em] text-slate-400">–¥–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</p>
        <h1 class="text-3xl font-semibold mt-2">
            {{ username }} <span class="animate-pulse">üëã</span>
        </h1>
    </section>

    <!-- =======================
    –î–û–•–û–î–´
    ======================= -->
    <section class="bg-slate-900/80 rounded-3xl p-5 border border-white/10">
        <h2 class="font-semibold mb-4">–î–æ—Ö–æ–¥—ã</h2>

        <div class="flex gap-4 flex-wrap">
            {% for c in income_categories %}
            <div class="relative w-24 text-center rounded-2xl p-2 hover:bg-slate-800 cursor-pointer"
                 onclick="openOpModal({{ c.id }}, 'income', '{{ c.name }}', '{{ c.icon }}')">

                <!-- DELETE -->
                <button onclick="deleteCategory(event, {{ c.id }})"
                        class="absolute top-1 right-1 text-xs text-slate-400 hover:text-red-400">‚úï</button>

                <div class="text-3xl">{{ c.icon }}</div>
                <p class="text-sm truncate">{{ c.name }}</p>
                <p class="text-xs text-slate-400">0 ‚Ç∏</p>
            </div>
            {% endfor %}

            <a href="/add_category?type=income&token={{ token }}"
               class="w-24 h-24 flex items-center justify-center rounded-2xl bg-slate-800 text-2xl">‚ûï</a>
        </div>
    </section>

    <!-- =======================
    –ö–û–®–ï–õ–¨–ö–ò
    ======================= -->
    <section class="bg-slate-900/80 rounded-3xl p-5 border border-white/10">
        <h2 class="font-semibold mb-4">–ö–æ—à–µ–ª—å–∫–∏</h2>

        <div class="flex gap-4 flex-wrap">
            {% for w in wallets %}
            <div class="w-28 text-center bg-slate-800/60 p-3 rounded-2xl">
                <div class="text-3xl">{{ w.icon or "üí≥" }}</div>
                <p class="text-sm">{{ w.name }}</p>
                <p class="text-emerald-400 font-semibold">{{ w.balance }} ‚Ç∏</p>
            </div>
            {% endfor %}

            <a href="/add_wallet?token={{ token }}"
               class="w-28 h-24 flex items-center justify-center rounded-2xl bg-slate-800 text-2xl">‚ûï</a>
        </div>
    </section>

    <!-- =======================
    –†–ê–°–•–û–î–´
    ======================= -->
    <section class="bg-slate-900/80 rounded-3xl p-5 border border-white/10">
        <h2 class="font-semibold mb-4">–†–∞—Å—Ö–æ–¥—ã</h2>

        <div class="flex gap-4 flex-wrap">
            {% for c in expense_categories %}
            <div class="relative w-24 text-center rounded-2xl p-2 hover:bg-slate-800 cursor-pointer"
                 onclick="openOpModal({{ c.id }}, 'expense', '{{ c.name }}', '{{ c.icon }}')">

                <button onclick="deleteCategory(event, {{ c.id }})"
                        class="absolute top-1 right-1 text-xs text-slate-400 hover:text-red-400">‚úï</button>

                <div class="text-3xl">{{ c.icon }}</div>
                <p class="text-sm truncate">{{ c.name }}</p>
                <p class="text-xs text-slate-400">0 ‚Ç∏</p>
            </div>
            {% endfor %}

            <a href="/add_category?type=expense&token={{ token }}"
               class="w-24 h-24 flex items-center justify-center rounded-2xl bg-slate-800 text-2xl">‚ûï</a>
        </div>
    </section>
</div>

<!-- =======================
MODAL
======================= -->
<div id="opModal"
     class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50">

    <div class="bg-slate-900 w-[380px] rounded-2xl p-6 border border-white/10">
        <div class="flex justify-between items-center mb-4">
            <h2 id="opTitle" class="font-semibold text-lg"></h2>
            <button onclick="closeOpModal()">‚úï</button>
        </div>

        <form method="post" action="/add_operation" class="space-y-4">
            <input type="hidden" name="token" value="{{ token }}">
            <input type="hidden" name="category_id" id="opCategoryId">
            <input type="hidden" name="type" id="opType">

            <select name="wallet_id" required
                    class="w-full bg-slate-800 p-3 rounded-xl">
                {% for w in wallets %}
                <option value="{{ w.id }}">{{ w.name }}</option>
                {% endfor %}
            </select>

            <input name="amount" type="number" step="0.01" required
                   placeholder="–°—É–º–º–∞"
                   class="w-full bg-slate-800 p-3 rounded-xl">

            <input name="description"
                   placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"
                   class="w-full bg-slate-800 p-3 rounded-xl">

            <button class="w-full bg-indigo-600 hover:bg-indigo-500 p-3 rounded-xl">
                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
            </button>
        </form>
    </div>
</div>

<script>
function openOpModal(id, type, name, icon) {
    document.getElementById("opModal").classList.remove("hidden");
    document.getElementById("opModal").classList.add("flex");

    document.getElementById("opTitle").innerText =
        icon + " " + name + (type === 'income' ? " ‚Äî –¥–æ—Ö–æ–¥" : " ‚Äî —Ä–∞—Å—Ö–æ–¥");

    document.getElementById("opCategoryId").value = id;
    document.getElementById("opType").value = type;
}

function closeOpModal() {
    document.getElementById("opModal").classList.add("hidden");
}

function deleteCategory(e, id) {
    e.stopPropagation();
    if (!confirm("–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é?")) return;

    fetch(`/delete_category/${id}?token={{ token }}`, { method: "POST" })
        .then(() => location.reload());
}
</script>

{% endblock %}
