{% extends "layout.html" %}
{% block content %}

<div class="mt-6 space-y-8">

    <!-- –í–ï–†–•–ù–ò–ô –ë–õ–û–ö: –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ + –±–∞–ª–∞–Ω—Å + –∫–Ω–æ–ø–∫–∏ -->
    <section
        class="bg-slate-900/80 rounded-3xl border border-white/10 shadow-xl shadow-black/40
               px-6 py-6 md:px-8 md:py-7 flex flex-col md:flex-row md:items-center md:justify-between gap-6 fade">

        <div class="space-y-3">
            <p class="text-xs uppercase tracking-[0.18em] text-slate-400">
                –¥–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å
            </p>

            <h1 class="text-3xl md:text-4xl font-semibold tracking-tight">
                {{ username }} <span class="inline-block animate-pulse">üëã</span>
            </h1>

            <p class="text-sm text-slate-400">
                –í–∞—à —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å:
            </p>
        </div>

        <div class="flex flex-col items-stretch md:items-end gap-4 w-full md:w-auto">

            <!-- –ë–∞–ª–∞–Ω—Å -->
            <div
                class="rounded-2xl bg-gradient-to-br from-emerald-500/15 via-slate-900 to-slate-950
                       px-6 py-4 border border-emerald-400/30 shadow-inner w-full md:w-64">
                <p class="text-[11px] uppercase tracking-[0.16em] text-emerald-300/80 mb-1">
                    –±–∞–ª–∞–Ω—Å, ‚Ç∏
                </p>
                <p class="text-3xl font-semibold text-emerald-400">
                    {{ "%.1f"|format(balance) }}
                </p>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
            <div class="flex flex-wrap gap-3 justify-between md:justify-end">

                <a href="/add_expense?token={{ token }}"
                   class="inline-flex items-center gap-2 px-5 py-3 rounded-xl
                          bg-rose-500 hover:bg-rose-400 text-white text-sm font-semibold
                          shadow-lg shadow-rose-900/40 transform hover:-translate-y-0.5
                          transition-all duration-200">
                    <span class="text-lg">‚ûñ</span>
                    <span>–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥</span>
                </a>

                <a href="/add_income?token={{ token }}"
                   class="inline-flex items-center gap-2 px-5 py-3 rounded-xl
                          bg-emerald-500 hover:bg-emerald-400 text-white text-sm font-semibold
                          shadow-lg shadow-emerald-900/40 transform hover:-translate-y-0.5
                          transition-all duration-200">
                    <span class="text-lg">‚ûï</span>
                    <span>–î–æ–±–∞–≤–∏—Ç—å –¥–æ—Ö–æ–¥</span>
                </a>

                <a href="/history?token={{ token }}"
                   class="inline-flex items-center gap-2 px-5 py-3 rounded-xl
                          bg-slate-800 hover:bg-slate-700 text-slate-100 text-sm font-semibold
                          shadow-lg shadow-black/30 transform hover:-translate-y-0.5
                          transition-all duration-200">
                    <span class="text-lg">üìú</span>
                    <span>–ò—Å—Ç–æ—Ä–∏—è</span>
                </a>
            </div>
        </div>
    </section>

    <!-- –ù–ò–ñ–ù–ò–ô –†–Ø–î –ö–ê–†–¢–û–ß–ï–ö -->
    <section class="grid gap-4 md:grid-cols-4">

        <!-- –ò—Ç–æ–≥–∏ –º–µ—Å—è—Ü–∞ -->
        <div
            class="bg-slate-900/80 rounded-3xl p-5 border border-white/10 shadow-lg
                   hover:shadow-2xl hover:-translate-y-1 transition-all duration-200 card">

            <h2 class="text-base font-semibold mb-4 flex items-center gap-2">
                <span class="inline-flex h-8 w-8 items-center justify-center rounded-xl
                             bg-slate-800 text-lg">üìä</span>
                <span>–ò—Ç–æ–≥–∏ –º–µ—Å—è—Ü–∞</span>
            </h2>

            <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                    <span class="text-slate-400">–î–æ—Ö–æ–¥:</span>
                    <span class="text-emerald-400 font-semibold">
                        {{ month_income }} ‚Ç∏
                    </span>
                </div>
                <div class="flex justify-between">
                    <span class="text-slate-400">–†–∞—Å—Ö–æ–¥:</span>
                    <span class="text-rose-400 font-semibold">
                        {{ month_expense }} ‚Ç∏
                    </span>
                </div>
                <div class="flex justify-between">
                    <span class="text-slate-400">–ë–∞–ª–∞–Ω—Å:</span>
                    <span class="text-indigo-400 font-semibold">
                        {{ month_balance }} ‚Ç∏
                    </span>
                </div>
            </div>
        </div>

        <!-- –¢–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–π -->
        <div
            class="bg-slate-900/80 rounded-3xl p-5 border border-white/10 shadow-lg
                   hover:shadow-2xl hover:-translate-y-1 transition-all duration-200 card">

            <h2 class="text-base font-semibold mb-4 flex items-center gap-2">
                <span class="inline-flex h-8 w-8 items-center justify-center rounded-xl
                             bg-orange-500/20 text-lg">üî•</span>
                <span>–¢–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ —Ä–∞—Å—Ö–æ–¥–∞–º</span>
            </h2>

            {% if top_categories %}
                <div class="space-y-1.5 text-sm">
                    {% for name, total in top_categories %}
                        <div class="flex justify-between">
                            <span class="text-slate-300 truncate pr-2">{{ name }}</span>
                            <span class="text-slate-100 font-medium">{{ total }} ‚Ç∏</span>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-slate-500 text-sm">
                    –ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ä–∞—Å—Ö–æ–¥–∞–º –∑–∞ —ç—Ç–æ—Ç –º–µ—Å—è—Ü.
                </p>
            {% endif %}
        </div>

        <!-- –ü–æ—Å–ª–µ–¥–Ω—è—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è -->
        <div
            class="bg-slate-900/80 rounded-3xl p-5 border border-white/10 shadow-lg
                   hover:shadow-2xl hover:-translate-y-1 transition-all duration-200 card">

            <h2 class="text-base font-semibold mb-4 flex items-center gap-2">
                <span class="inline-flex h-8 w-8 items-center justify-center rounded-xl
                             bg-pink-500/20 text-lg">üìå</span>
                <span>–ü–æ—Å–ª–µ–¥–Ω—è—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è</span>
            </h2>

            {% if last_transaction %}
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span class="text-slate-400">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</span>
                        <span class="text-slate-100 font-medium">
                            {{ last_transaction.category }}
                        </span>
                    </div>

                    <div class="flex justify-between">
                        <span class="text-slate-400">–°—É–º–º–∞:</span>
                        <span class="
                            font-semibold
                            {% if last_transaction.type == 'income' %}
                                text-emerald-400
                            {% else %}
                                text-rose-400
                            {% endif %}
                        ">
                            {{ last_transaction.amount }} ‚Ç∏
                        </span>
                    </div>

                    <div class="flex justify-between text-xs">
                        <span class="text-slate-400">–î–∞—Ç–∞:</span>
                        <span class="text-slate-500">
                            {{ last_transaction.date }}
                        </span>
                    </div>

                    <p class="text-xs text-slate-400 mt-1">
                        {{ last_transaction.description or "–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è" }}
                    </p>
                </div>
            {% else %}
                <p class="text-slate-500 text-sm">
                    –ï—â—ë –Ω–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.
                </p>
            {% endif %}
        </div>

        <!-- –¢–µ–∫—É—â–∞—è —Ü–µ–ª—å -->
        <div
            class="bg-slate-900/80 rounded-3xl p-5 border border-white/10 shadow-lg
                   hover:shadow-2xl hover:-translate-y-1 transition-all duration-200 card">

            <h2 class="text-base font-semibold mb-4 flex items-center gap-2">
                <span class="inline-flex h-8 w-8 items-center justify-center rounded-xl
                             bg-indigo-500/20 text-lg">üéØ</span>
                <span>–¶–µ–ª—å</span>
            </h2>

            {% if goal %}
                <p class="text-sm font-medium text-slate-100 mb-2">
                    {{ goal.name }}
                </p>
                <p class="text-xs text-slate-400 mb-2">
                    {{ goal.saved }} / {{ goal.target }} ‚Ç∏
                </p>

                <div class="w-full h-2 rounded-full bg-slate-800 overflow-hidden mb-3">
                    <div class="h-full rounded-full bg-indigo-500 transition-all duration-300"
                         style="width: {{ goal.percent }}%;"></div>
                </div>

                <div class="flex items-center justify-between text-xs text-slate-400">
                    <span>–ü—Ä–æ–≥—Ä–µ—Å—Å</span>
                    <span class="text-indigo-400 font-semibold">{{ goal.percent }}%</span>
                </div>

                <a href="/goals?token={{ token }}"
                   class="mt-3 inline-flex items-center gap-1 text-xs text-indigo-400 hover:text-indigo-300">
                    –û—Ç–∫—Ä—ã—Ç—å –≤—Å–µ —Ü–µ–ª–∏ ‚Üí
                </a>
            {% else %}
                <p class="text-slate-500 text-sm mb-3">
                    –£ –≤–∞—Å –µ—â—ë –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–π —Ü–µ–ª–∏.
                </p>
                <a href="/add_goal?token={{ token }}"
                   class="inline-flex items-center gap-2 px-4 py-2 rounded-xl
                          bg-indigo-600 hover:bg-indigo-500 text-white text-xs font-semibold
                          shadow shadow-black/40 transition">
                    <span>–°–æ–∑–¥–∞—Ç—å —Ü–µ–ª—å</span>
                </a>
            {% endif %}
        </div>

    </section>

</div>

<!-- üîµ –ö–ù–û–ü–ö–ê –ß–ê–¢–ê -->
<button id="chatToggleBtn"
        class="fixed bottom-6 right-6 bg-indigo-600 hover:bg-indigo-500 text-white p-4 rounded-full shadow-lg shadow-black/40 text-xl transition transform hover:-translate-y-0.5 z-40">
    üí¨
</button>

<!-- üü£ –û–ö–ù–û –ß–ê–¢–ê -->
<div id="chatWindow"
     class="hidden fixed bottom-24 right-6 w-80 bg-slate-900/95 backdrop-blur-xl
            shadow-2xl shadow-black/60 rounded-2xl border border-white/10 overflow-hidden z-50">

    <div class="bg-slate-900/90 border-b border-white/10 text-slate-100 px-4 py-3 flex justify-between items-center">
        <div class="flex items-center gap-2">
            <span class="h-7 w-7 rounded-full bg-indigo-600 flex items-center justify-center text-sm">ü§ñ</span>
            <div>
                <p class="text-xs font-semibold leading-tight">AI –ü–æ–¥–¥–µ—Ä–∂–∫–∞</p>
                <p class="text-[10px] text-slate-400 leading-tight">FinanceBot –ø–æ–º–æ—â–Ω–∏–∫</p>
            </div>
        </div>
        <button id="chatCloseBtn" class="text-slate-400 hover:text-slate-200 text-lg leading-none">
            &times;
        </button>
    </div>

    <div id="chatMessages" class="h-64 overflow-y-auto p-3 space-y-2 text-sm bg-slate-950/80">
        <div class="text-slate-500 text-center text-xs">
            –°–ø—Ä–æ—Å–∏ –æ —Å–≤–æ–∏—Ö —Ä–∞—Å—Ö–æ–¥–∞—Ö, –∫–∞—Ç–µ–≥–æ—Ä–∏—è—Ö –∏–ª–∏ —Ü–µ–ª—è—Ö üí¨
        </div>
    </div>

    <div class="border-t border-white/10 p-2 bg-slate-900/90 flex gap-2 items-center">
        <input id="chatInput"
               class="flex-1 bg-slate-950/80 border border-slate-700/80 rounded-xl px-3 py-1.5 text-xs
                      text-slate-100 placeholder:text-slate-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
               placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ..."
               onkeydown="if(event.key==='Enter') sendChatMessage()">
        <button onclick="sendChatMessage()"
                class="bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-1.5 rounded-xl text-xs font-semibold">
            ‚û§
        </button>
    </div>
</div>

<script>
    const chatWindow = document.getElementById("chatWindow");
    const chatToggleBtn = document.getElementById("chatToggleBtn");
    const chatCloseBtn = document.getElementById("chatCloseBtn");

    if (chatToggleBtn) {
        chatToggleBtn.onclick = () => {
            chatWindow.classList.remove("hidden");
        };
    }

    if (chatCloseBtn) {
        chatCloseBtn.onclick = () => {
            chatWindow.classList.add("hidden");
        };
    }

    function appendChatMessage(author, text) {
        const box = document.getElementById("chatMessages");

        const wrapper = document.createElement("div");
        wrapper.className = author === "user" ? "text-right" : "text-left";

        const bubble = document.createElement("div");
        bubble.className =
            "inline-block px-3 py-2 rounded-2xl max-w-[80%] text-xs md:text-[13px] " +
            (author === "user"
                ? "bg-indigo-600 text-white ml-auto"
                : "bg-slate-800 text-slate-100");

        bubble.textContent = text;
        wrapper.appendChild(bubble);
        box.appendChild(wrapper);

        box.scrollTop = box.scrollHeight;
    }

    async function sendChatMessage() {
        const input = document.getElementById("chatInput");
        const msg = input.value.trim();
        if (!msg) return;

        appendChatMessage("user", msg);
        input.value = "";

        try {
            const resp = await fetch("/api/support_chat", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ message: msg })
            });

            const data = await resp.json();
            appendChatMessage("assistant", data.reply || "–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞.");
        } catch (e) {
            appendChatMessage("assistant", "–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º.");
        }
    }
</script>

{% endblock %}
