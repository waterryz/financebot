{% extends "layout.html" %}
{% block content %}

<div class="w-full space-y-6">

    <!-- –í–ï–†–•–ù–ò–ô –ë–õ–û–ö -->
    <section
      class="bg-slate-900/80 rounded-3xl border border-white/10
             shadow-xl shadow-black/40
             px-6 py-6 md:px-8 md:py-7
             flex flex-col lg:flex-row
             lg:items-center lg:justify-between
             gap-6"
    >

      <!-- –õ–ï–í–û: –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ -->
      <div class="space-y-3">
        <p class="text-xs uppercase tracking-[0.18em] text-slate-400">
          –¥–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å
        </p>

        <h1 class="text-3xl md:text-4xl font-semibold tracking-tight text-white">
          {{ username }} <span class="inline-block animate-pulse">üëã</span>
        </h1>
      </div>

      <!-- –ö–ù–û–ü–ö–ò -->
      <div class="flex flex-col gap-3 w-full lg:w-auto">
        <button
          onclick="openOperationModal(null,'expense')"
          class="h-[56px] w-full lg:w-[260px]
                 rounded-2xl
                 bg-rose-500 hover:bg-rose-600
                 text-white font-semibold
                 shadow-[0_0_30px_rgba(244,63,94,0.35)]
                 transition">
          ‚àí –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥
        </button>

        <button
          onclick="openOperationModal(null,'income')"
          class="h-[56px] w-full lg:w-[260px]
                 rounded-2xl
                 bg-emerald-500 hover:bg-emerald-600
                 text-white font-semibold
                 shadow-[0_0_30px_rgba(16,185,129,0.35)]
                 transition">
          + –î–æ–±–∞–≤–∏—Ç—å –¥–æ—Ö–æ–¥
        </button>

        <a
          href="/history?token={{ token }}"
          class="h-[56px] w-full lg:w-[260px]
                 rounded-2xl
                 bg-slate-700 hover:bg-slate-600
                 text-white font-semibold
                 flex items-center justify-center
                 border border-white/10
                 transition">
          üìú –ò—Å—Ç–æ—Ä–∏—è
        </a>
      </div>

      <!-- –ë–ê–õ–ê–ù–° -->
      <div
        class="rounded-2xl
               bg-gradient-to-br from-emerald-500/15 via-slate-900 to-slate-950
               px-6 py-4
               border border-emerald-400/30
               shadow-inner
               w-full lg:w-[260px]"
      >
        <p class="text-[11px] uppercase tracking-[0.16em] text-emerald-300/80 mb-1">
          –±–∞–ª–∞–Ω—Å, ‚Ç∏
        </p>

        <p class="font-semibold text-emerald-400 leading-none
                  text-[clamp(28px,4vw,52px)] whitespace-nowrap">
          {{ "{:,.0f}".format(total_balance).replace(",", " ") }} ‚Ç∏
        </p>
      </div>

    </section>

    {% if request.query_params.get("error") %}
        <div
            class="w-full rounded-2xl border border-rose-500/30 bg-rose-500/10 px-5 py-4
                   text-rose-300"
        >
            {{ request.query_params.get("error") }}
        </div>
    {% endif %}

    <!-- –î–û–•–û–î–´ + –ö–û–®–ï–õ–¨–ö–ò -->
    <section class="w-full">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

            <!-- –î–û–•–û–î–´ -->
            <div
                class="rounded-[28px] border border-white/10 bg-slate-900/70 shadow-2xl backdrop-blur-xl
                       px-6 py-6"
            >
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-semibold text-white">
                        –î–æ—Ö–æ–¥—ã
                    </h2>
                </div>

                <div class="mt-5 flex flex-wrap gap-5">
                    {% for c in income_categories %}
                        <!-- –í–ê–ñ–ù–û: –∫–∞—Ä—Ç–æ—á–∫–∞ div (–ù–ï button), —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞–ª–æ—Å—å -->
                        <div
                            role="button"
                            tabindex="0"
                            onclick="openOperationModal({{ c.id }}, 'income')"
                            class="group relative w-[96px] h-[96px] rounded-2xl border border-white/10
                                   bg-slate-800/40 hover:bg-slate-800/60
                                   shadow-[inset_0_1px_0_rgba(255,255,255,0.06)]
                                   transition flex flex-col items-center justify-center cursor-pointer"
                        >
                            <!-- –∫—Ä–µ—Å—Ç–∏–∫ —É–¥–∞–ª–∏—Ç—å -->
                            <button
                                type="button"
                                onclick="event.stopPropagation(); deleteCategory({{ c.id }})"
                                class="absolute top-1.5 right-1.5 w-5 h-5 rounded-full
                                       bg-rose-500 hover:bg-rose-600 text-white text-xs font-bold
                                       flex items-center justify-center
                                       opacity-0 group-hover:opacity-100 transition"
                                title="–£–¥–∞–ª–∏—Ç—å"
                            >√ó</button>

                            <div class="text-3xl group-hover:scale-110 transition">
                                {{ c.icon }}
                            </div>
                            <div class="mt-2 text-xs text-slate-200 truncate max-w-[86px]">
                                {{ c.name }}
                            </div>
                        </div>
                    {% endfor %}

                    <button
                        type="button"
                        onclick="openCategoryModal('income')"
                        class="w-[96px] h-[96px] rounded-2xl border border-white/10
                               bg-slate-800/20 hover:bg-slate-800/45
                               flex items-center justify-center
                               transition"
                    >
                        <div class="text-3xl text-white/90">
                            +
                        </div>
                    </button>
                </div>
            </div>

            <!-- –ö–û–®–ï–õ–¨–ö–ò -->
            <div
                class="rounded-[28px] border border-white/10 bg-slate-900/70 shadow-2xl backdrop-blur-xl
                       px-6 py-6"
            >
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-semibold text-white">
                        –ö–æ—à–µ–ª—å–∫–∏
                    </h2>
                </div>

                <div class="mt-5 flex flex-wrap gap-5">
                    {% for w in wallets %}
                        <div
                            class="group relative w-[116px] h-[116px] rounded-2xl border border-white/10
                                   bg-slate-800/35 shadow-[inset_0_1px_0_rgba(255,255,255,0.06)]
                                   flex flex-col items-center justify-center"
                        >
                            <!-- –∫—Ä–µ—Å—Ç–∏–∫ —É–¥–∞–ª–∏—Ç—å -->
                            <button
                                type="button"
                                onclick="deleteWallet({{ w.id }})"
                                class="absolute top-2 right-2 w-5 h-5 rounded-full
                                       bg-rose-500 hover:bg-rose-600 text-white text-xs font-bold
                                       flex items-center justify-center
                                       opacity-0 group-hover:opacity-100 transition"
                                title="–£–¥–∞–ª–∏—Ç—å"
                            >√ó</button>

                            <div class="text-3xl">
                                {{ w.icon or 'üí≥' }}
                            </div>
                            <div class="mt-2 text-sm text-slate-100 truncate max-w-[104px]">
                                {{ w.name }}
                            </div>
                            <div class="mt-1 text-sm font-semibold text-emerald-400">
                                {{ w.balance }} ‚Ç∏
                            </div>
                        </div>
                    {% endfor %}

                    <button
                        type="button"
                        onclick="openWalletModal()"
                        class="w-[116px] h-[116px] rounded-2xl border border-white/10
                               bg-slate-800/20 hover:bg-slate-800/45
                               flex items-center justify-center transition"
                    >
                        <div class="text-3xl text-white/90">
                            +
                        </div>
                    </button>
                </div>
            </div>

        </div>
    </section>

    <!-- –†–ê–°–•–û–î–´ -->
    <section class="w-full">
        <div
            class="rounded-[28px] border border-white/10 bg-slate-900/70 shadow-2xl backdrop-blur-xl
                   px-6 py-6"
        >
            <div class="flex items-center justify-between">
                <h2 class="text-3xl font-semibold text-white">
                    –†–∞—Å—Ö–æ–¥—ã
                </h2>
            </div>

            <div class="mt-5 flex flex-wrap gap-5">
                {% for c in expense_categories %}
                    <!-- –í–ê–ñ–ù–û: –∫–∞—Ä—Ç–æ—á–∫–∞ div (–ù–ï button), —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞–ª–æ—Å—å -->
                    <div
                        role="button"
                        tabindex="0"
                        onclick="openOperationModal({{ c.id }}, 'expense')"
                        class="group relative w-[96px] h-[96px] rounded-2xl border border-white/10
                               bg-slate-800/40 hover:bg-slate-800/60
                               shadow-[inset_0_1px_0_rgba(255,255,255,0.06)]
                               transition flex flex-col items-center justify-center cursor-pointer"
                    >
                        <!-- –∫—Ä–µ—Å—Ç–∏–∫ —É–¥–∞–ª–∏—Ç—å -->
                        <button
                            type="button"
                            onclick="event.stopPropagation(); deleteCategory({{ c.id }})"
                            class="absolute top-1.5 right-1.5 w-5 h-5 rounded-full
                                   bg-rose-500 hover:bg-rose-600 text-white text-xs font-bold
                                   flex items-center justify-center
                                   opacity-0 group-hover:opacity-100 transition"
                            title="–£–¥–∞–ª–∏—Ç—å"
                        >√ó</button>

                        <div class="text-3xl group-hover:scale-110 transition">
                            {{ c.icon }}
                        </div>
                        <div class="mt-2 text-xs text-slate-200 truncate max-w-[86px]">
                            {{ c.name }}
                        </div>
                    </div>
                {% endfor %}

                <button
                    type="button"
                    onclick="openCategoryModal('expense')"
                    class="w-[96px] h-[96px] rounded-2xl border border-white/10
                           bg-slate-800/20 hover:bg-slate-800/45
                           flex items-center justify-center transition"
                >
                    <div class="text-3xl text-white/90">
                        +
                    </div>
                </button>
            </div>
        </div>
    </section>

    <!-- –°–¢–ê–¢–ò–°–¢–ò–ö–ê -->
    <section class="w-full">
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-5">

            <div class="rounded-[22px] border border-white/10 bg-slate-900/70 shadow-2xl backdrop-blur-xl px-5 py-5">
                <div class="flex items-center gap-3">
                    <div class="text-xl">üìä</div>
                    <div class="text-lg font-semibold text-white">–ò—Ç–æ–≥–∏ –º–µ—Å—è—Ü–∞</div>
                </div>

                <div class="mt-4 space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span class="text-slate-400">–î–æ—Ö–æ–¥</span>
                        <span class="text-emerald-400 font-semibold">{{ month_income }} ‚Ç∏</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-slate-400">–†–∞—Å—Ö–æ–¥</span>
                        <span class="text-rose-400 font-semibold">{{ month_expense }} ‚Ç∏</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-slate-400">–ë–∞–ª–∞–Ω—Å</span>
                        <span class="text-indigo-300 font-semibold">{{ month_balance }} ‚Ç∏</span>
                    </div>
                </div>
            </div>

            <div class="rounded-[22px] border border-white/10 bg-slate-900/70 shadow-2xl backdrop-blur-xl px-5 py-5">
                <div class="flex items-center gap-3">
                    <div class="text-xl">üî•</div>
                    <div class="text-lg font-semibold text-white">–¢–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</div>
                </div>

                <div class="mt-4 space-y-2 text-sm">
                    {% if top_categories %}
                        {% for name, total in top_categories %}
                            <div class="flex justify-between">
                                <span class="text-slate-200 truncate max-w-[170px]">{{ name }}</span>
                                <span class="text-slate-100 font-semibold">{{ total }} ‚Ç∏</span>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-slate-500">
                            –ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="rounded-[22px] border border-white/10 bg-slate-900/70 shadow-2xl backdrop-blur-xl px-5 py-5">
                <div class="flex items-center gap-3">
                    <div class="text-xl">üìå</div>
                    <div class="text-lg font-semibold text-white">–ü–æ—Å–ª–µ–¥–Ω—è—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è</div>
                </div>

                <div class="mt-4">
                    {% if last_transaction %}
                        <div class="text-sm text-slate-200">
                            –ö–∞—Ç–µ–≥–æ—Ä–∏—è:
                            <span class="font-semibold">{{ last_transaction.category }}</span>
                        </div>
                        <div class="mt-2 text-2xl font-semibold text-white">
                            {{ last_transaction.amount }} ‚Ç∏
                        </div>
                        <div class="mt-2 text-xs text-slate-500">
                            {{ last_transaction.date }}
                        </div>
                    {% else %}
                        <div class="text-slate-500">
                            –ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="rounded-[22px] border border-white/10 bg-slate-900/70 shadow-2xl backdrop-blur-xl px-5 py-5">
                <div class="flex items-center gap-3">
                    <div class="text-xl">üéØ</div>
                    <div class="text-lg font-semibold text-white">–¶–µ–ª—å</div>
                </div>

                <div class="mt-4">
                    {% if goal %}
                        <div class="text-sm text-slate-200">
                            {{ goal.name }}
                        </div>
                        <div class="mt-1 text-xs text-slate-500">
                            {{ goal.saved }} / {{ goal.target }} ‚Ç∏
                        </div>

                        <div class="mt-3 w-full h-2 rounded-full bg-slate-800 overflow-hidden">
                            <div class="h-full bg-indigo-500 transition-all duration-700"
                                 style="width: {{ goal.percent }}%">
                            </div>
                        </div>

                        <div class="mt-2 text-sm text-indigo-300">
                            –ü—Ä–æ–≥—Ä–µ—Å—Å: {{ goal.percent }}%
                        </div>
                    {% else %}
                        <div class="text-slate-500">
                            –¶–µ–ª—å –Ω–µ –∑–∞–¥–∞–Ω–∞
                        </div>
                    {% endif %}
                </div>
            </div>

        </div>
    </section>

</div>

<!-- ====================== MODALS ====================== -->

<div id="operationModal" class="fixed inset-0 hidden items-center justify-center bg-black/60 z-50 px-4">
    <div class="w-full max-w-[520px] rounded-[28px] border border-white/10 bg-slate-950/80 backdrop-blur-xl shadow-2xl">
        <form id="operationForm" class="p-6 space-y-4">
            <input type="hidden" name="token" value="{{ token }}">
            <input type="hidden" name="type" id="opType">

            <div class="text-center">
                <div id="opTitle" class="text-xl font-semibold text-white"></div>
                <div class="mt-1 text-sm text-slate-400">
                    –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ—à–µ–ª—ë–∫, –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏ —Å—É–º–º—É
                </div>
            </div>

            <div class="grid grid-cols-1 gap-3">
                <select name="wallet_id" required
                        class="w-full rounded-2xl bg-slate-800/60 border border-white/10 px-4 py-3 text-slate-100">
                    {% for w in wallets %}
                        <option value="{{ w.id }}">{{ w.name }}</option>
                    {% endfor %}
                </select>

                <select id="opCategorySelectIncome" name="category_id"
                        class="hidden w-full rounded-2xl bg-slate-800/60 border border-white/10 px-4 py-3 text-slate-100">
                    {% for c in income_categories %}
                        <option value="{{ c.id }}">{{ c.icon }} {{ c.name }}</option>
                    {% endfor %}
                </select>

                <select id="opCategorySelectExpense" name="category_id"
                        class="hidden w-full rounded-2xl bg-slate-800/60 border border-white/10 px-4 py-3 text-slate-100">
                    {% for c in expense_categories %}
                        <option value="{{ c.id }}">{{ c.icon }} {{ c.name }}</option>
                    {% endfor %}
                </select>

                <input name="amount" type="number" step="0.01" required placeholder="–°—É–º–º–∞"
                       class="w-full rounded-2xl bg-slate-800/60 border border-white/10 px-4 py-3 text-slate-100">

                <input name="description" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"
                       class="w-full rounded-2xl bg-slate-800/60 border border-white/10 px-4 py-3 text-slate-100">
            </div>

            <div id="opError"
                 class="hidden rounded-2xl border border-rose-500/30 bg-rose-500/10 px-4 py-3 text-rose-300 text-sm text-center">
            </div>

            <div class="grid grid-cols-2 gap-3 pt-2">
                <button type="submit"
                        class="rounded-2xl bg-emerald-500/90 hover:bg-emerald-500 text-white font-semibold py-3 border border-white/10 transition">
                    –ì–æ—Ç–æ–≤–æ
                </button>
                <button type="button" onclick="closeOperationModal()"
                        class="rounded-2xl bg-slate-700/60 hover:bg-slate-700 text-white font-semibold py-3 border border-white/10 transition">
                    –û—Ç–º–µ–Ω–∞
                </button>
            </div>
        </form>
    </div>
</div>

<div id="categoryModal" class="fixed inset-0 hidden items-center justify-center bg-black/60 z-50 px-4">
    <div class="w-full max-w-[560px] rounded-[28px] border border-white/10 bg-slate-950/80 backdrop-blur-xl shadow-2xl">
        <form method="post" action="/add_category" class="p-6" id="categoryForm">
            <input type="hidden" name="token" value="{{ token }}">
            <input type="hidden" name="type" id="catType">
            <input type="hidden" name="icon" id="catIcon">

            <div class="text-center">
                <div class="text-2xl font-semibold text-white">–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è</div>
                <div class="mt-2 text-sm text-slate-400">–í—ã–±–µ—Ä–∏—Ç–µ –∏–∫–æ–Ω–∫—É –∏–∑ —Å–ø–∏—Å–∫–∞ –Ω–∏–∂–µ</div>
            </div>

            <div class="mt-5">
                <input name="name" required placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏"
                       class="w-full rounded-2xl bg-slate-800/60 border border-white/10 px-4 py-3 text-slate-100">
            </div>

            <div class="mt-5 grid grid-cols-6 gap-3">
                {% for icon in ['üíº','üí∞','üçî','‚òï','üöó','üè†','üéÆ','üõí','üì¶','üéÅ','üíä','‚öΩ','‚úàÔ∏è','üì±','üíé','üí≥','üè¶','üßæ','üöå','üéì','üëï','üê∂','üéß','üçø'] %}
                    <button type="button"
                            class="icon-btn rounded-2xl border border-white/10 bg-slate-800/45 hover:bg-slate-800/70 text-2xl py-3 transition"
                            onclick="selectIcon(this,'{{ icon }}')">
                        {{ icon }}
                    </button>
                {% endfor %}
            </div>

            <div id="catError"
                 class="hidden mt-4 rounded-2xl border border-rose-500/30 bg-rose-500/10 px-4 py-3 text-rose-300 text-sm text-center">
            </div>

            <div class="grid grid-cols-2 gap-3 mt-6">
                <button type="submit"
                        class="rounded-2xl bg-indigo-500/90 hover:bg-indigo-500 text-white font-semibold py-3 border border-white/10 transition">
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
                <button type="button" onclick="closeCategoryModal()"
                        class="rounded-2xl bg-slate-700/60 hover:bg-slate-700 text-white font-semibold py-3 border border-white/10 transition">
                    –û—Ç–º–µ–Ω–∞
                </button>
            </div>
        </form>
    </div>
</div>

<div id="walletModal" class="fixed inset-0 hidden items-center justify-center bg-black/60 z-50 px-4">
    <div class="w-full max-w-[560px] rounded-[28px] border border-white/10 bg-slate-950/80 backdrop-blur-xl shadow-2xl">
        <form method="post" action="/add_wallet" class="p-6" id="walletForm">
            <input type="hidden" name="token" value="{{ token }}">
            <input type="hidden" name="icon" id="walletIcon">

            <div class="text-center">
                <div class="text-2xl font-semibold text-white">–ù–æ–≤—ã–π –∫–æ—à–µ–ª—ë–∫</div>
                <div class="mt-2 text-sm text-slate-400">–ù–∞–∑–≤–∞–Ω–∏–µ + –∏–∫–æ–Ω–∫–∞ –∏–∑ –≥–æ—Ç–æ–≤—ã—Ö</div>
            </div>

            <div class="mt-5">
                <input name="name" required placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞"
                       class="w-full rounded-2xl bg-slate-800/60 border border-white/10 px-4 py-3 text-slate-100">
            </div>

            <div class="mt-5 grid grid-cols-6 gap-3">
                {% for icon in ['üí≥','üí∞','üëõ','üè¶','üì±','ü™ô','üíµ','üí∂','üí∑','üí¥','üßæ','üèß'] %}
                    <button type="button"
                            class="wallet-icon-btn rounded-2xl border border-white/10 bg-slate-800/45 hover:bg-slate-800/70 text-2xl py-3 transition"
                            onclick="selectWalletIcon(this,'{{ icon }}')">
                        {{ icon }}
                    </button>
                {% endfor %}
            </div>

            <div id="walletError"
                 class="hidden mt-4 rounded-2xl border border-rose-500/30 bg-rose-500/10 px-4 py-3 text-rose-300 text-sm text-center">
            </div>

            <div class="grid grid-cols-2 gap-3 mt-6">
                <button type="submit"
                        class="rounded-2xl bg-indigo-500/90 hover:bg-indigo-500 text-white font-semibold py-3 border border-white/10 transition">
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
                <button type="button" onclick="closeWalletModal()"
                        class="rounded-2xl bg-slate-700/60 hover:bg-slate-700 text-white font-semibold py-3 border border-white/10 transition">
                    –û—Ç–º–µ–Ω–∞
                </button>
            </div>
        </form>
    </div>
</div>

<script>
const $ = (id) => document.getElementById(id)

function openOperationModal(categoryId, type) {
    $("opType").value = type

    const title = type === "income" ? "–î–æ–±–∞–≤–∏—Ç—å –¥–æ—Ö–æ–¥" : "–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥"
    $("opTitle").innerText = title

    const selIncome = $("opCategorySelectIncome")
    const selExpense = $("opCategorySelectExpense")

    selIncome.classList.add("hidden")
    selExpense.classList.add("hidden")

    if (type === "income") {
        selIncome.classList.remove("hidden")
        if (categoryId) selIncome.value = String(categoryId)
    } else {
        selExpense.classList.remove("hidden")
        if (categoryId) selExpense.value = String(categoryId)
    }

    $("opError").classList.add("hidden")
    $("opError").innerText = ""

    $("operationModal").classList.remove("hidden")
    $("operationModal").classList.add("flex")
}

function closeOperationModal() {
    $("operationModal").classList.add("hidden")
    $("operationModal").classList.remove("flex")
}

function openCategoryModal(type) {
    $("catType").value = type
    $("catIcon").value = ""

    const catError = $("catError")
    catError.classList.add("hidden")
    catError.innerText = ""

    document.querySelectorAll(".icon-btn").forEach(b => {
        b.classList.remove("ring-2","ring-indigo-400","scale-110")
    })

    $("categoryModal").classList.remove("hidden")
    $("categoryModal").classList.add("flex")
}

function closeCategoryModal() {
    $("categoryModal").classList.add("hidden")
    $("categoryModal").classList.remove("flex")
}

function openWalletModal() {
    $("walletIcon").value = ""

    const walletError = $("walletError")
    walletError.classList.add("hidden")
    walletError.innerText = ""

    document.querySelectorAll(".wallet-icon-btn").forEach(b => {
        b.classList.remove("ring-2","ring-indigo-400","scale-110")
    })

    $("walletModal").classList.remove("hidden")
    $("walletModal").classList.add("flex")
}

function closeWalletModal() {
    $("walletModal").classList.add("hidden")
    $("walletModal").classList.remove("flex")
}

function selectIcon(btn, icon) {
    $("catIcon").value = icon

    document.querySelectorAll(".icon-btn").forEach(b => {
        b.classList.remove("ring-2","ring-indigo-400","scale-110")
    })

    btn.classList.add("ring-2","ring-indigo-400","scale-110")
}

function selectWalletIcon(btn, icon) {
    $("walletIcon").value = icon

    document.querySelectorAll(".wallet-icon-btn").forEach(b => {
        b.classList.remove("ring-2","ring-indigo-400","scale-110")
    })

    btn.classList.add("ring-2","ring-indigo-400","scale-110")
}

const opForm = $("operationForm")
opForm.addEventListener("submit", async (e) => {
    e.preventDefault()

    const err = $("opError")
    err.classList.add("hidden")
    err.innerText = ""

    const res = await fetch("/add_operation", {
        method: "POST",
        body: new FormData(opForm)
    })

    let data = null
    try {
        data = await res.json()
    } catch (_) {
        err.innerText = "–û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞"
        err.classList.remove("hidden")
        return
    }

    if (!data.success) {
        err.innerText = data.error || "–û—à–∏–±–∫–∞"
        err.classList.remove("hidden")
        return
    }

    window.location.reload()
})

const catForm = $("categoryForm")
catForm.addEventListener("submit", (e) => {
    const icon = $("catIcon").value
    if (!icon) {
        e.preventDefault()
        const box = $("catError")
        box.innerText = "–í—ã–±–µ—Ä–∏—Ç–µ –∏–∫–æ–Ω–∫—É"
        box.classList.remove("hidden")
    }
})

const walletForm = $("walletForm")
walletForm.addEventListener("submit", (e) => {
    const icon = $("walletIcon").value
    if (!icon) {
        e.preventDefault()
        const box = $("walletError")
        box.innerText = "–í—ã–±–µ—Ä–∏—Ç–µ –∏–∫–æ–Ω–∫—É"
        box.classList.remove("hidden")
    }
})

$("operationModal").addEventListener("click", (e) => {
    if (e.target === $("operationModal")) closeOperationModal()
})
$("categoryModal").addEventListener("click", (e) => {
    if (e.target === $("categoryModal")) closeCategoryModal()
})
$("walletModal").addEventListener("click", (e) => {
    if (e.target === $("walletModal")) closeWalletModal()
})

/* ================== –£–î–ê–õ–ï–ù–ò–ï (–¢–û–õ–¨–ö–û –î–û–ë–ê–í–ò–õ) ================== */

async function deleteCategory(id) {
    event.stopPropagation()

    if (!confirm("–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é?")) return

    const res = await fetch("/delete_category", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body: new URLSearchParams({
            token: "{{ token }}",
            category_id: id
        })
    })

    location.reload()
}

async function deleteWallet(id) {
    event.stopPropagation()

    if (!confirm("–£–¥–∞–ª–∏—Ç—å –∫–æ—à–µ–ª—ë–∫?")) return

    const res = await fetch("/delete_wallet", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body: new URLSearchParams({
            token: "{{ token }}",
            wallet_id: id
        })
    })

    location.reload()
}

</script>

{% endblock %}
